# AFitness 健身管理系统 - 技术架构文档

> 版本：v1.4.0 | 最后更新：2026-01-07

---

## 目录

1. [技术架构概述](#1-技术架构概述)
2. [后端技术架构](#2-后端技术架构)
3. [前端技术架构](#3-前端技术架构)
4. [数据库架构](#4-数据库架构)
5. [安全架构](#5-安全架构)
6. [缓存架构](#6-缓存架构)
7. [监控与可观测性](#7-监控与可观测性)
8. [部署架构](#8-部署架构)
9. [核心算法与业务逻辑](#9-核心算法与业务逻辑)
10. [技术选型理由](#10-技术选型理由)

---

## 1. 技术架构概述

### 1.1 系统架构图

```
                              ┌─────────────────────────────────────┐
                              │           客户端层                   │
                              │  ┌─────────┐  ┌─────────┐  ┌─────┐ │
                              │  │ 用户端  │  │ 管理端  │  │移动端│ │
                              │  │ Vue 3   │  │ Vue 3   │  │ H5  │ │
                              │  │ :3001   │  │ :3002   │  │     │ │
                              │  └────┬────┘  └────┬────┘  └──┬──┘ │
                              └───────┼───────────┼──────────┼────┘
                                      │           │          │
                                      └─────────┬─┴──────────┘
                                                │
                              ┌─────────────────▼─────────────────┐
                              │          网关/代理层               │
                              │  ┌─────────────────────────────┐  │
                              │  │  Nginx / Vite Dev Proxy     │  │
                              │  │  - 负载均衡                  │  │
                              │  │  - SSL终止                   │  │
                              │  │  - 静态资源服务              │  │
                              │  └─────────────────────────────┘  │
                              └─────────────────┬─────────────────┘
                                                │
                              ┌─────────────────▼─────────────────┐
                              │          应用服务层                │
                              │  ┌─────────────────────────────┐  │
                              │  │     Spring Boot 3.2.5       │  │
                              │  │  ┌───────────────────────┐  │  │
                              │  │  │   Security Filters    │  │  │
                              │  │  │  - CORS Filter        │  │  │
                              │  │  │  - XSS Filter         │  │  │
                              │  │  │  - JWT Auth Filter    │  │  │
                              │  │  └───────────┬───────────┘  │  │
                              │  │              │              │  │
                              │  │  ┌───────────▼───────────┐  │  │
                              │  │  │    Controller Layer   │  │  │
                              │  │  │  - REST API           │  │  │
                              │  │  │  - 参数校验            │  │  │
                              │  │  └───────────┬───────────┘  │  │
                              │  │              │              │  │
                              │  │  ┌───────────▼───────────┐  │  │
                              │  │  │    Service Layer      │  │  │
                              │  │  │  - 业务逻辑            │  │  │
                              │  │  │  - 事务管理            │  │  │
                              │  │  │  - 缓存处理            │  │  │
                              │  │  └───────────┬───────────┘  │  │
                              │  │              │              │  │
                              │  │  ┌───────────▼───────────┐  │  │
                              │  │  │   Repository Layer    │  │  │
                              │  │  │  - JPA/Hibernate      │  │  │
                              │  │  │  - 数据访问            │  │  │
                              │  │  └───────────────────────┘  │  │
                              │  └─────────────────────────────┘  │
                              └─────────────────┬─────────────────┘
                                                │
                    ┌───────────────────────────┼───────────────────────────┐
                    │                           │                           │
          ┌─────────▼─────────┐       ┌─────────▼─────────┐       ┌─────────▼─────────┐
          │    缓存层          │       │    数据层          │       │    监控层          │
          │  ┌─────────────┐  │       │  ┌─────────────┐  │       │  ┌─────────────┐  │
          │  │  Caffeine   │  │       │  │   MySQL     │  │       │  │  Actuator   │  │
          │  │  (L1本地)   │  │       │  │   8.0       │  │       │  │  Prometheus │  │
          │  └─────────────┘  │       │  └─────────────┘  │       │  │  Micrometer │  │
          │  ┌─────────────┐  │       │  ┌─────────────┐  │       │  └─────────────┘  │
          │  │   Redis     │  │       │  │  HikariCP   │  │       └───────────────────┘
          │  │  (L2分布式) │  │       │  │  连接池     │  │
          │  └─────────────┘  │       │  └─────────────┘  │
          └───────────────────┘       └───────────────────┘
```

### 1.2 技术栈总览

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| **前端框架** | Vue.js | 3.3.4 | 渐进式JavaScript框架 |
| **前端构建** | Vite | 4.4.9 | 下一代前端构建工具 |
| **UI组件库** | Element Plus | 2.8.0 | Vue 3 组件库 |
| **状态管理** | Pinia | 2.1.6 | Vue 3 状态管理 |
| **图表库** | ECharts | 5.4.3 | 数据可视化 |
| **后端框架** | Spring Boot | 3.2.5 | Java应用框架 |
| **安全框架** | Spring Security | 6.2.x | 认证授权 |
| **ORM框架** | Spring Data JPA | 3.2.5 | 数据访问 |
| **数据库** | MySQL | 8.0.33 | 关系型数据库 |
| **本地缓存** | Caffeine | 3.x | 高性能本地缓存 |
| **分布式缓存** | Redis | 7.x | 分布式缓存（可选） |
| **连接池** | HikariCP | 5.x | 高性能连接池 |
| **JWT** | jjwt | 0.11.5 | JSON Web Token |
| **API文档** | SpringDoc | 2.2.0 | OpenAPI 3.0 |
| **监控** | Micrometer | 1.12.x | 应用指标 |
| **日志** | Logback | 1.4.x | 日志框架 |
| **测试** | JUnit 5 | 5.10.x | 单元测试 |
| **属性测试** | jqwik | 1.8.2 | 属性测试框架 |
| **性能测试** | Gatling | 3.10.3 | 负载测试 |
| **E2E测试** | Playwright | 1.57.0 | 端到端测试 |


---

## 2. 后端技术架构

### 2.1 分层架构详解

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Spring Boot Application                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                     Filter Chain (过滤器链)                     │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐   │ │
│  │  │CorsFilter│─►│XssFilter │─►│JwtFilter │─►│SecurityFilter│   │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────┘   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                    │                              │
│  ┌─────────────────────────────────▼──────────────────────────────┐ │
│  │                    Controller Layer (控制器层)                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐│ │
│  │  │@RestController│ │@Valid       │  │@Operation (Swagger)    ││ │
│  │  │@RequestMapping│ │参数校验      │  │API文档注解              ││ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘│ │
│  │  职责: 接收请求、参数校验、调用Service、返回响应                  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                    │                                 │
│  ┌─────────────────────────────────▼──────────────────────────────┐ │
│  │                     Service Layer (服务层)                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐│ │
│  │  │@Service     │  │@Transactional│ │@Cacheable/@CacheEvict  ││ │
│  │  │业务逻辑      │  │事务管理      │  │缓存管理                 ││ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘│ │
│  │  职责: 业务逻辑处理、事务控制、缓存操作、数据转换                  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                    │                                 │
│  ┌─────────────────────────────────▼──────────────────────────────┐ │
│  │                   Repository Layer (数据访问层)                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐│ │
│  │  │JpaRepository│  │@Query       │  │Specification           ││ │
│  │  │CRUD操作     │  │自定义查询    │  │动态查询                 ││ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘│ │
│  │  职责: 数据持久化、查询操作、数据库交互                          │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                    │                                 │
│  ┌─────────────────────────────────▼──────────────────────────────┐ │
│  │                      Entity Layer (实体层)                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐│ │
│  │  │@Entity      │  │@Table       │  │Validation Annotations  ││ │
│  │  │JPA实体      │  │表映射       │  │字段校验                  ││ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘│ │
│  │  职责: 数据模型定义、ORM映射、字段约束                           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件详解

#### 2.2.1 Spring Security 安全架构

```
HTTP请求
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│                    SecurityFilterChain                         │
│                                                                │
│  ┌──────────────┐                                             │
│  │ CorsFilter   │  处理跨域请求                                │
│  └──────┬───────┘                                             │
│         │                                                      │
│  ┌──────▼───────┐                                             │
│  │ XssFilter    │  XSS攻击防护                                 │
│  └──────┬───────┘                                             │
│         │                                                      │
│  ┌──────▼───────────────┐                                     │
│  │JwtAuthenticationFilter│  JWT令牌验证                        │
│  │  - 提取Token          │                                     │
│  │  - 验证签名           │                                     │
│  │  - 解析用户信息       │                                     │
│  │  - 设置SecurityContext│                                     │
│  └──────┬───────────────┘                                     │
│         │                                                      │
│  ┌──────▼───────────────┐                                     │
│  │AuthorizationFilter   │  权限检查                            │
│  │  - URL权限匹配        │                                     │
│  │  - 角色检查           │                                     │
│  └──────────────────────┘                                     │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```

#### 2.2.2 JWT 认证流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        JWT 认证流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 登录请求                                                     │
│     ┌────────┐    POST /api/v1/auth/login    ┌────────────────┐ │
│     │ Client │ ─────────────────────────────► │ AuthController │ │
│     └────────┘    {username, password}        └───────┬────────┘ │
│                                                       │          │
│  2. 验证凭据                                          │          │
│     ┌────────────────────┐                           │          │
│     │AuthenticationService│◄──────────────────────────┘          │
│     │  - 查询用户         │                                      │
│     │  - 验证密码(BCrypt) │                                      │
│     └─────────┬──────────┘                                      │
│               │                                                  │
│  3. 生成Token                                                    │
│     ┌─────────▼──────────┐                                      │
│     │  JwtTokenProvider  │                                      │
│     │  - 生成AccessToken │  有效期: 24小时                       │
│     │  - 生成RefreshToken│  有效期: 7天                          │
│     └─────────┬──────────┘                                      │
│               │                                                  │
│  4. 返回Token                                                    │
│     ┌────────┐    {accessToken, refreshToken}    ┌────────────┐ │
│     │ Client │◄───────────────────────────────── │  Response  │ │
│     └────────┘                                   └────────────┘ │
│                                                                 │
│  5. 后续请求                                                     │
│     ┌────────┐    Authorization: Bearer <token>  ┌────────────┐ │
│     │ Client │ ─────────────────────────────────►│ API Server │ │
│     └────────┘                                   └────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.2.3 AOP 切面架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        AOP 切面架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    DatabaseRetryAspect                       ││
│  │  切点: @annotation(DatabaseRetryable)                        ││
│  │  功能: 数据库操作自动重试                                     ││
│  │  策略: 指数退避 (1s → 2s → 4s → 8s → ...)                    ││
│  │  最大重试: 3次                                               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      AuditAspect                             ││
│  │  切点: @annotation(Auditable)                                ││
│  │  功能: 审计日志记录                                          ││
│  │  记录: 操作类型、资源、用户、时间、结果                        ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                  TransactionAspect                           ││
│  │  切点: @Transactional                                        ││
│  │  功能: 声明式事务管理                                         ││
│  │  传播: REQUIRED (默认)                                       ││
│  │  隔离: READ_COMMITTED                                        ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  执行顺序:                                                       │
│  请求 → AuditAspect → TransactionAspect → DatabaseRetryAspect   │
│       → 目标方法 → 返回                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 异常处理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    GlobalExceptionHandler                        │
│                    @RestControllerAdvice                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 业务异常处理                                                  ││
│  │ @ExceptionHandler(BusinessException.class)                   ││
│  │ → HTTP 400 + 业务错误码                                      ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 参数校验异常                                                  ││
│  │ @ExceptionHandler(MethodArgumentNotValidException.class)     ││
│  │ → HTTP 400 + 字段错误详情                                    ││
│  │ 返回格式:                                                     ││
│  │ {                                                            ││
│  │   "fieldErrors": {                                           ││
│  │     "username": {                                            ││
│  │       "field": "username",                                   ││
│  │       "message": "用户名不能为空",                            ││
│  │       "rejectedValue": null,                                 ││
│  │       "constraintType": "Required"                           ││
│  │     }                                                        ││
│  │   }                                                          ││
│  │ }                                                            ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 认证异常                                                      ││
│  │ @ExceptionHandler(AuthenticationException.class)             ││
│  │ → HTTP 401 + "认证失败"                                      ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 权限异常                                                      ││
│  │ @ExceptionHandler(AccessDeniedException.class)               ││
│  │ → HTTP 403 + "访问被拒绝"                                    ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 数据库连接异常                                                ││
│  │ @ExceptionHandler(CannotGetJdbcConnectionException.class)    ││
│  │ → HTTP 503 + "数据库连接暂时不可用"                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 通用异常                                                      ││
│  │ @ExceptionHandler(Exception.class)                           ││
│  │ → HTTP 500 + "服务器内部错误"                                ││
│  │ → 记录详细日志                                               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```


---

## 3. 前端技术架构

### 3.1 Vue 3 应用架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Vue 3 Application                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                        main.js                               ││
│  │  - 创建Vue应用实例                                           ││
│  │  - 注册全局插件 (Pinia, Router, Element Plus)                ││
│  │  - 挂载根组件                                                ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
│  ┌───────────────────────────▼─────────────────────────────────┐│
│  │                        App.vue                               ││
│  │  - 根组件                                                    ││
│  │  - 全局布局                                                  ││
│  │  - <router-view> 路由出口                                    ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
│  ┌───────────────────────────┼─────────────────────────────────┐│
│  │                           │                                  ││
│  │  ┌────────────────┐  ┌────▼───────────┐  ┌────────────────┐ ││
│  │  │    Router      │  │    Stores      │  │   Composables  │ ││
│  │  │  (Vue Router)  │  │   (Pinia)      │  │  (组合式函数)   │ ││
│  │  │                │  │                │  │                │ ││
│  │  │ - 路由定义     │  │ - user.js      │  │ - useConnection│ ││
│  │  │ - 路由守卫     │  │ - training.js  │  │ - useTheme     │ ││
│  │  │ - 懒加载       │  │ - nutrition.js │  │ - useOffline   │ ││
│  │  └────────────────┘  └────────────────┘  └────────────────┘ ││
│  │                                                              ││
│  └──────────────────────────────────────────────────────────────┘│
│                              │                                   │
│  ┌───────────────────────────▼─────────────────────────────────┐│
│  │                        Views                                 ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  ││
│  │  │ Dashboard   │  │TrainingData │  │ NutritionTracking   │  ││
│  │  │ 仪表盘      │  │ 训练数据    │  │ 营养追踪            │  ││
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  ││
│  │  │RecoveryStatus│ │ Settings    │  │ admin/*             │  ││
│  │  │ 恢复状态    │  │ 设置        │  │ 管理端页面          │  ││
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  ││
│  └──────────────────────────────────────────────────────────────┘│
│                              │                                   │
│  ┌───────────────────────────▼─────────────────────────────────┐│
│  │                      Components                              ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ ││
│  │  │DataVisualization│  │TrainingRecordMgr│  │ErrorBoundary │ ││
│  │  │ 数据可视化      │  │ 训练记录管理    │  │ 错误边界     │ ││
│  │  └─────────────────┘  └─────────────────┘  └──────────────┘ ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ ││
│  │  │CalorieCalculator│  │OneRepMaxCalc    │  │ConnectionInd │ ││
│  │  │ 卡路里计算器    │  │ 1RM计算器       │  │ 连接状态指示 │ ││
│  │  └─────────────────┘  └─────────────────┘  └──────────────┘ ││
│  └──────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 状态管理架构 (Pinia)

```
┌─────────────────────────────────────────────────────────────────┐
│                      Pinia Store 架构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      useUserStore                            ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ State (状态)                                             │││
│  │  │  - currentUser: User | null                              │││
│  │  │  - isAuthenticated: boolean                              │││
│  │  │  - roles: string[]                                       │││
│  │  │  - loading: boolean                                      │││
│  │  └─────────────────────────────────────────────────────────┘││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ Getters (计算属性)                                       │││
│  │  │  - token: () => localStorage.getItem('token')            │││
│  │  │  - isAdmin: () => roles.includes('ADMIN')                │││
│  │  │  - displayName: () => user?.nickname || user?.username   │││
│  │  └─────────────────────────────────────────────────────────┘││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ Actions (方法)                                           │││
│  │  │  - login(credentials)                                    │││
│  │  │  - logout()                                              │││
│  │  │  - refreshToken()                                        │││
│  │  │  - fetchCurrentUser()                                    │││
│  │  │  - updateProfile(data)                                   │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    useTrainingStore                          ││
│  │  State: records[], currentRecord, stats, pagination          ││
│  │  Getters: todayRecords, totalVolume, hasMore                 ││
│  │  Actions: fetchRecords, createRecord, deleteRecord           ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    useNutritionStore                         ││
│  │  State: records[], dailyStats, goals                         ││
│  │  Getters: totalCalories, macroRatio                          ││
│  │  Actions: fetchRecords, addRecord, getStats                  ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 API 请求架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Axios 请求架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    request.js (核心封装)                     ││
│  │                                                              ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ Axios Instance                                          │││
│  │  │  - baseURL: '' (使用Vite代理)                           │││
│  │  │  - timeout: 30000ms                                     │││
│  │  │  - withCredentials: true                                │││
│  │  └─────────────────────────────────────────────────────────┘││
│  │                                                              ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ Request Interceptor (请求拦截器)                         │││
│  │  │  1. 添加 Authorization Header                           │││
│  │  │  2. 添加时间戳防缓存                                     │││
│  │  │  3. 请求去重处理                                         │││
│  │  └─────────────────────────────────────────────────────────┘││
│  │                                                              ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ Response Interceptor (响应拦截器)                        │││
│  │  │  1. 统一响应处理                                         │││
│  │  │  2. 401 → Token刷新 → 重试请求                          │││
│  │  │  3. 错误消息提示                                         │││
│  │  │  4. 会话过期处理                                         │││
│  │  └─────────────────────────────────────────────────────────┘││
│  │                                                              ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ Retry Mechanism (重试机制)                               │││
│  │  │  - 最大重试次数: 3                                       │││
│  │  │  - 指数退避: 1s → 2s → 4s                               │││
│  │  │  - 可重试状态码: 500, 502, 503, 504, 408                │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    API Modules (API模块)                     ││
│  │                                                              ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       ││
│  │  │  auth.js     │  │ training.js  │  │ nutrition.js │       ││
│  │  │  - login     │  │ - getRecords │  │ - getRecords │       ││
│  │  │  - register  │  │ - create     │  │ - addRecord  │       ││
│  │  │  - refresh   │  │ - update     │  │ - getStats   │       ││
│  │  │  - logout    │  │ - delete     │  │ - getAdvice  │       ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘       ││
│  │                                                              ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       ││
│  │  │  user.js     │  │ dashboard.js │  │  admin.js    │       ││
│  │  │  - getProfile│  │ - getMetrics │  │ - getUsers   │       ││
│  │  │  - update    │  │ - getStats   │  │ - getMonitor │       ││
│  │  │  - changePwd │  │ - getRecent  │  │ - export     │       ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘       ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 路由架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Vue Router 架构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  路由配置:                                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ /login          → Login.vue          (公开)                  ││
│  │ /dashboard      → Dashboard.vue      (需认证, USER)          ││
│  │ /training-data  → TrainingData.vue   (需认证, USER)          ││
│  │ /nutrition      → NutritionTracking  (需认证, USER)          ││
│  │ /recovery       → RecoveryStatus     (需认证, USER)          ││
│  │ /settings       → Settings.vue       (需认证)                ││
│  │ /admin/*        → admin/*.vue        (需认证, ADMIN)         ││
│  │ /*              → NotFound.vue       (404)                   ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  路由守卫:                                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ router.beforeEach((to, from, next) => {                     ││
│  │                                                              ││
│  │   // 1. 设置页面标题                                         ││
│  │   document.title = to.meta.title + ' - AFitness'            ││
│  │                                                              ││
│  │   // 2. 检查认证状态                                         ││
│  │   if (requiresAuth && !token) {                             ││
│  │     next('/login')                                          ││
│  │     return                                                  ││
│  │   }                                                         ││
│  │                                                              ││
│  │   // 3. 已登录访问登录页 → 跳转到对应首页                         ││
│  │   if (to.path === '/login' && token) {                      ││
│  │     next(isAdmin ? '/admin/dashboard' : '/dashboard')       ││
│  │     return                                                  ││
│  │   }                                                         ││
│  │                                                             ││
│  │   // 4. 检查角色权限                                           ││
│  │   if (routeRole === 'ADMIN' && !isAdmin) {                  ││
│  │     next('/dashboard')                                      ││
│  │     return                                                  ││
│  │   }                                                         ││
│  │                                                              ││
│  │   next()                                                    ││
│  │ })                                                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  懒加载:                                                         │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ component: () => import('../views/Dashboard.vue')           ││
│  │ // Vite 自动代码分割，按需加载                                   ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```


---

## 4. 数据库架构

### 4.1 数据模型关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据模型关系图                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                              ┌─────────────────┐                            │
│                              │   user_table    │                            │
│                              │   (用户表)       │                            │
│                              ├─────────────────┤                            │
│                              │ PK: id          │                            │
│                              │ username        │                            │
│                              │ password        │                            │
│                              │ email           │                            │
│                              │ role            │                            │
│                              │ age, weight...  │                            │
│                              └────────┬────────┘                            │
│                                       │                                      │
│           ┌───────────────────────────┼───────────────────────────┐         │
│           │                           │                           │         │
│           ▼                           ▼                           ▼         │
│  ┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐  │
│  │training_records │        │nutrition_records│        │  recovery_data  │  │
│  │  (训练记录)      │        │  (营养记录)      │        │  (恢复数据)     │  │
│  ├─────────────────┤        ├─────────────────┤        ├─────────────────┤  │
│  │ PK: id          │        │ PK: id          │        │ PK: id          │  │
│  │ FK: user_id     │        │ FK: user_id     │        │ FK: user_id     │  │
│  │ exercise_name   │        │ record_date     │        │ recovery_score  │  │
│  │ sets, reps      │        │ meal_type       │        │ sleep_hours     │  │
│  │ weight          │        │ food_name       │        │ stress_level    │  │
│  │ training_date   │        │ calories        │        │ muscle_soreness │  │
│  │ total_volume    │        │ protein, carbs  │        │ timestamp       │  │
│  │ deleted (软删除) │        │ fat, fiber      │        └─────────────────┘  │
│  └────────┬────────┘        └─────────────────┘                             │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────┐                                                        │
│  │exercise_details │                                                        │
│  │  (动作详情)      │                                                        │
│  ├─────────────────┤                                                        │
│  │ PK: id          │                                                        │
│  │ FK: record_id   │                                                        │
│  │ exercise_name   │                                                        │
│  │ weight, sets    │                                                        │
│  │ reps, rpe       │                                                        │
│  │ volume          │                                                        │
│  └─────────────────┘                                                        │
│                                                                              │
│  其他关联表:                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ training_plans  │  │ training_advice │  │   audit_logs    │             │
│  │  (训练计划)      │  │  (训练建议)      │  │  (审计日志)     │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 软删除机制

```
┌─────────────────────────────────────────────────────────────────┐
│                        软删除实现                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  BaseEntity (基础实体):                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ @MappedSuperclass                                           ││
│  │ public abstract class BaseEntity {                          ││
│  │     private Boolean deleted = false;                        ││
│  │     private LocalDateTime deletedAt;                        ││
│  │     private Long deletedBy;                                 ││
│  │ }                                                           ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  实体配置:                                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ @Entity                                                     ││
│  │ @SQLRestriction("deleted = false")  // 自动过滤已删除记录    ││
│  │ public class TrainingRecord extends BaseEntity {            ││
│  │     // ...                                                  ││
│  │ }                                                           ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  Repository 方法:                                                │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ // 软删除                                                    ││
│  │ @Modifying                                                  ││
│  │ @Query("UPDATE TrainingRecord tr SET tr.deleted = true, "   ││
│  │        "tr.deletedAt = :deletedAt, tr.deletedBy = :userId " ││
│  │        "WHERE tr.id = :id AND tr.deleted = false")          ││
│  │ int softDelete(Long id, LocalDateTime deletedAt, Long userId);││
│  │                                                              ││
│  │ // 恢复                                                      ││
│  │ @Modifying                                                  ││
│  │ @Query("UPDATE TrainingRecord tr SET tr.deleted = false, "  ││
│  │        "tr.deletedAt = null, tr.deletedBy = null "          ││
│  │        "WHERE tr.id = :id AND tr.deleted = true")           ││
│  │ int restore(Long id);                                       ││
│  │                                                              ││
│  │ // 查询已删除记录                                            ││
│  │ @Query("SELECT tr FROM TrainingRecord tr "                  ││
│  │        "WHERE tr.user.id = :userId AND tr.deleted = true")  ││
│  │ List<TrainingRecord> findDeletedByUserId(Long userId);      ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 连接池配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    HikariCP 连接池配置                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  配置参数:                                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ maximum-pool-size: 20      # 最大连接数                      ││
│  │ minimum-idle: 5            # 最小空闲连接                    ││
│  │ idle-timeout: 300000       # 空闲超时 (5分钟)                ││
│  │ max-lifetime: 1200000      # 连接最大生命周期 (20分钟)       ││
│  │ connection-timeout: 30000  # 连接超时 (30秒)                 ││
│  │ validation-timeout: 5000   # 验证超时 (5秒)                  ││
│  │ leak-detection-threshold: 60000  # 泄漏检测阈值 (1分钟)      ││
│  │ keepalive-time: 120000     # 保活时间 (2分钟)                ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  连接池状态监控:                                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ GET /actuator/metrics/hikaricp.connections.active           ││
│  │ GET /actuator/metrics/hikaricp.connections.idle             ││
│  │ GET /actuator/metrics/hikaricp.connections.pending          ││
│  │ GET /actuator/metrics/hikaricp.connections.timeout          ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  连接池工作流程:                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                                                              ││
│  │  请求 ──► 从池中获取连接 ──► 执行SQL ──► 归还连接到池        ││
│  │              │                                               ││
│  │              │ 无可用连接                                    ││
│  │              ▼                                               ││
│  │         创建新连接 (如果未达到最大值)                         ││
│  │              │                                               ││
│  │              │ 已达最大值                                    ││
│  │              ▼                                               ││
│  │         等待 (最多 connection-timeout)                       ││
│  │              │                                               ││
│  │              │ 超时                                          ││
│  │              ▼                                               ││
│  │         抛出 CannotGetJdbcConnectionException                ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 安全架构

### 5.1 安全层次模型

```
┌─────────────────────────────────────────────────────────────────┐
│                        安全层次模型                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Layer 1: 网络层安全                                          ││
│  │  - HTTPS/TLS 加密传输                                        ││
│  │  - CORS 跨域策略                                             ││
│  │  - 请求频率限制                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Layer 2: 应用层安全                                           ││
│  │  - JWT 令牌认证                                               ││
│  │  - 角色权限控制 (RBAC)                                        ││
│  │  - XSS 防护过滤                                              ││
│  │  - SQL 注入防护 (JPA参数化查询)                                ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Layer 3: 数据层安全                                          ││
│  │  - 密码 BCrypt 加密存储                                      ││
│  │  - 敏感数据脱敏                                              ││
│  │  - 数据访问审计                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Layer 4: 业务层安全                                          ││
│  │  - 输入参数校验                                              ││
│  │  - 业务规则验证                                              ││
│  │  - 操作审计日志                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 认证授权流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      认证授权完整流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 用户登录                                                     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Client                    Server                            ││
│  │   │                         │                               ││
│  │   │  POST /api/v1/auth/login                                ││
│  │   │  {username, password}   │                               ││
│  │   │ ───────────────────────►│                               ││
│  │   │                         │                               ││
│  │   │                         │ 1. 查询用户                    ││
│  │   │                         │ 2. BCrypt验证密码              ││
│  │   │                         │ 3. 生成JWT Token               ││
│  │   │                         │                               ││
│  │   │  {accessToken,          │                               ││
│  │   │   refreshToken,         │                               ││
│  │   │   expiresIn}            │                               ││
│  │   │ ◄───────────────────────│                               ││
│  │   │                         │                               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  2. 访问受保护资源                                               │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Client                    Server                            ││
│  │   │                         │                               ││
│  │   │  GET /api/v1/training/records                           ││
│  │   │  Authorization: Bearer <token>                          ││
│  │   │ ───────────────────────►│                               ││
│  │   │                         │                               ││
│  │   │                         │ JwtAuthFilter:                 ││
│  │   │                         │ 1. 提取Token                   ││
│  │   │                         │ 2. 验证签名                    ││
│  │   │                         │ 3. 检查过期                    ││
│  │   │                         │ 4. 设置SecurityContext         ││
│  │   │                         │                               ││
│  │   │                         │ AuthorizationFilter:           ││
│  │   │                         │ 1. 检查URL权限                 ││
│  │   │                         │ 2. 检查角色                    ││
│  │   │                         │                               ││
│  │   │  {data: [...]}          │                               ││
│  │   │ ◄───────────────────────│                               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  3. Token 刷新                                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Client                    Server                            ││
│  │   │                         │                               ││
│  │   │  POST /api/v1/auth/refresh                              ││
│  │   │  {refreshToken}         │                               ││
│  │   │ ───────────────────────►│                               ││
│  │   │                         │                               ││
│  │   │                         │ 1. 验证RefreshToken            ││
│  │   │                         │ 2. 生成新AccessToken           ││
│  │   │                         │                               ││
│  │   │  {accessToken}          │                               ││
│  │   │ ◄───────────────────────│                               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```



---

## 6. 缓存架构

### 6.1 多级缓存架构概述

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           多级缓存架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                          请求处理流程                                     ││
│  │                                                                         ││
│  │   请求 ──► L1 Caffeine ──► L2 Redis ──► Database                         ││
│  │              │                │              │                          ││
│  │              │ 命中           │ 命中         │ 查询                       ││
│  │              ▼                ▼              ▼                          ││
│  │           返回数据         返回数据       返回数据                          ││
│  │              │                │              │                          ││
│  │              │                │              │ 写入L2                    ││
│  │              │                │              ▼                           ││
│  │              │                │         Redis缓存                        ││
│  │              │                │              │                           ││
│  │              │                │              │ 写入L1                    ││
│  │              │                │              ▼                           ││
│  │              │                │         Caffeine缓存                     ││
│  │              │                │              │                           ││
│  │              ◄────────────────┴──────────────┘                           ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  缓存层级特点:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  L1 - Caffeine (本地缓存)                                                ││
│  │  ├── 位置: JVM 堆内存                                                    ││
│  │  ├── 延迟: ~1μs (微秒级)                                                 ││
│  │  ├── 容量: 1000条目 (可配置)                                             ││
│  │  ├── 过期: 写入后30分钟 / 访问后15分钟                                   ││
│  │  └── 适用: 热点数据、高频访问数据                                        ││
│  │                                                                          ││
│  │  L2 - Redis (分布式缓存)                                                 ││
│  │  ├── 位置: 独立Redis服务器                                               ││
│  │  ├── 延迟: ~1ms (毫秒级)                                                 ││
│  │  ├── 容量: 取决于Redis内存配置                                           ││
│  │  ├── 过期: 根据数据类型2分钟~24小时不等                                  ││
│  │  └── 适用: 分布式场景、数据共享、持久化缓存                              ││
│  │                                                                          ││
│  │  L3 - Database (MySQL)                                                   ││
│  │  ├── 位置: 磁盘存储                                                      ││
│  │  ├── 延迟: ~10ms (毫秒级)                                                ││
│  │  ├── 容量: 无限制                                                        ││
│  │  └── 适用: 数据持久化、复杂查询                                          ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 6.2 Caffeine 本地缓存详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Caffeine 缓存配置详解                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  配置类: CaffeineCacheConfig.java                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Configuration                                                          ││
│  │ @EnableCaching                                                          ││
│  │ public class CaffeineCacheConfig {                                      ││
│  │                                                                          ││
│  │     @Bean                                                               ││
│  │     @Primary  // 设为主缓存管理器                                        ││
│  │     public CacheManager caffeineCacheManager() {                        ││
│  │         CaffeineCacheManager cacheManager = new CaffeineCacheManager(); ││
│  │                                                                          ││
│  │         cacheManager.setCaffeine(Caffeine.newBuilder()                  ││
│  │             .initialCapacity(100)           // 初始容量                  ││
│  │             .maximumSize(1000)              // 最大条目数                ││
│  │             .expireAfterWrite(Duration.ofMinutes(30))  // 写后过期       ││
│  │             .expireAfterAccess(Duration.ofMinutes(15)) // 访问后过期     ││
│  │             .recordStats());                // 启用统计                  ││
│  │                                                                          ││
│  │         return cacheManager;                                            ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  预定义缓存区域:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 缓存名称              │ 用途                    │ 典型数据               ││
│  │ ─────────────────────┼────────────────────────┼─────────────────────── ││
│  │ users                │ 用户信息缓存            │ 用户基本信息、角色      ││
│  │ trainingRecords      │ 训练记录缓存            │ 用户训练数据            ││
│  │ nutritionStats       │ 营养统计缓存            │ 每日营养汇总            ││
│  │ dashboardMetrics     │ 仪表盘指标缓存          │ 统计数据、图表数据      ││
│  │ userStats            │ 用户统计缓存            │ 用户活跃度、成就        ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Caffeine 驱逐策略:                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  Window TinyLFU 算法 (Caffeine 默认)                                     ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │                                                                  │    ││
│  │  │  新数据 ──► Window Cache (1%) ──► Main Cache (99%)              │    ││
│  │  │                  │                      │                        │    ││
│  │  │                  │                      │                        │    ││
│  │  │                  ▼                      ▼                        │    ││
│  │  │            Probation区              Protected区                  │    ││
│  │  │            (试用区)                 (保护区)                     │    ││
│  │  │                  │                      │                        │    ││
│  │  │                  │ 频繁访问             │ 不活跃                  │    ││
│  │  │                  ▼                      ▼                        │    ││
│  │  │            晋升到Protected         降级到Probation               │    ││
│  │  │                                                                  │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  │                                                                          ││
│  │  优势:                                                                   ││
│  │  - 结合 LRU 和 LFU 的优点                                                ││
│  │  - 高命中率 (接近最优)                                                   ││
│  │  - 低内存开销                                                            ││
│  │  - O(1) 时间复杂度                                                       ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 6.3 Redis 分布式缓存详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Redis 缓存配置详解                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  配置类: RedisConfig.java                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Configuration                                                          ││
│  │ @EnableCaching                                                          ││
│  │ @ConditionalOnProperty(name = "spring.data.redis.host")                 ││
│  │ public class RedisConfig {                                              ││
│  │                                                                          ││
│  │     // RedisTemplate 配置                                               ││
│  │     @Bean                                                               ││
│  │     public RedisTemplate<String, Object> redisTemplate(...) {           ││
│  │         template.setKeySerializer(new StringRedisSerializer());         ││
│  │         template.setValueSerializer(new GenericJackson2JsonRedisSerializer());││
│  │         return template;                                                ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     // Redis 缓存管理器                                                  ││
│  │     @Bean(name = "redisCacheManager")                                   ││
│  │     public RedisCacheManager redisCacheManager(...) {                   ││
│  │         // 分层TTL配置                                                   ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  分层 TTL 策略:                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 缓存区域              │ TTL        │ 说明                               ││
│  │ ─────────────────────┼───────────┼─────────────────────────────────── ││
│  │ userCache            │ 30分钟     │ 用户信息变化较少                    ││
│  │ userProfileCache     │ 15分钟     │ 用户资料                            ││
│  │ trainingRecordCache  │ 5分钟      │ 训练数据变化频繁                    ││
│  │ nutritionRecordCache │ 5分钟      │ 营养数据变化频繁                    ││
│  │ dashboardStatsCache  │ 2分钟      │ 需要较新数据                        ││
│  │ trainingSuggestionCache│ 1小时    │ AI建议不需频繁更新                  ││
│  │ foodDatabaseCache    │ 24小时     │ 静态数据                            ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  序列化配置:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  Key 序列化: StringRedisSerializer                                       ││
│  │  ├── 格式: 纯字符串                                                      ││
│  │  ├── 示例: "userCache::user:123"                                        ││
│  │  └── 优点: 可读性好，便于调试                                            ││
│  │                                                                          ││
│  │  Value 序列化: GenericJackson2JsonRedisSerializer                        ││
│  │  ├── 格式: JSON                                                          ││
│  │  ├── 示例: {"id":123,"username":"john","email":"john@example.com"}      ││
│  │  └── 优点: 跨语言兼容，可读性好                                          ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 6.4 缓存使用模式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          缓存使用模式                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. Cache-Aside 模式 (旁路缓存)                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  读取流程:                                                               ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │ @Cacheable(value = "users", key = "#userId")                    │    ││
│  │  │ public User getUserById(Long userId) {                          │    ││
│  │  │     // 1. 先查缓存 (Spring自动处理)                              │    ││
│  │  │     // 2. 缓存未命中，执行方法查询数据库                          │    ││
│  │  │     // 3. 将结果写入缓存 (Spring自动处理)                        │    ││
│  │  │     return userRepository.findById(userId).orElse(null);        │    ││
│  │  │ }                                                               │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  │                                                                          ││
│  │  写入流程:                                                               ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │ @CacheEvict(value = "users", key = "#user.id")                  │    ││
│  │  │ public User updateUser(User user) {                             │    ││
│  │  │     // 1. 更新数据库                                             │    ││
│  │  │     // 2. 删除缓存 (Spring自动处理)                              │    ││
│  │  │     return userRepository.save(user);                           │    ││
│  │  │ }                                                               │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  2. 缓存注解详解                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  @Cacheable - 查询缓存                                                   ││
│  │  ├── value: 缓存名称                                                     ││
│  │  ├── key: 缓存键 (SpEL表达式)                                            ││
│  │  ├── condition: 缓存条件                                                 ││
│  │  ├── unless: 排除条件                                                    ││
│  │  └── cacheManager: 指定缓存管理器                                        ││
│  │                                                                          ││
│  │  @CacheEvict - 删除缓存                                                  ││
│  │  ├── value: 缓存名称                                                     ││
│  │  ├── key: 缓存键                                                         ││
│  │  ├── allEntries: 是否清空所有                                            ││
│  │  └── beforeInvocation: 是否在方法执行前删除                              ││
│  │                                                                          ││
│  │  @CachePut - 更新缓存                                                    ││
│  │  ├── 总是执行方法并更新缓存                                              ││
│  │  └── 适用于需要返回最新数据的场景                                        ││
│  │                                                                          ││
│  │  @Caching - 组合注解                                                     ││
│  │  └── 可组合多个缓存操作                                                  ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  3. 实际使用示例                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  // 训练记录服务                                                         ││
│  │  @Service                                                               ││
│  │  public class TrainingRecordServiceImpl {                               ││
│  │                                                                          ││
│  │      @Cacheable(value = "trainingRecords",                              ││
│  │                 key = "'user:' + #userId + ':page:' + #page")           ││
│  │      public Page<TrainingRecord> getRecords(Long userId, int page) {    ││
│  │          return repository.findByUserId(userId, PageRequest.of(page, 10));││
│  │      }                                                                  ││
│  │                                                                          ││
│  │      @Caching(evict = {                                                 ││
│  │          @CacheEvict(value = "trainingRecords",                         ││
│  │                      key = "'user:' + #record.user.id + ':*'"),         ││
│  │          @CacheEvict(value = "dashboardMetrics",                        ││
│  │                      key = "'user:' + #record.user.id")                 ││
│  │      })                                                                 ││
│  │      public TrainingRecord createRecord(TrainingRecord record) {        ││
│  │          return repository.save(record);                                ││
│  │      }                                                                  ││
│  │  }                                                                      ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 6.5 缓存一致性策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        缓存一致性策略                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 写入策略                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  Cache-Aside (本项目采用)                                                ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │                                                                  │    ││
│  │  │  写入: 先更新DB → 再删除缓存                                     │    ││
│  │  │                                                                  │    ││
│  │  │  优点:                                                           │    ││
│  │  │  - 实现简单                                                      │    ││
│  │  │  - 数据一致性较好                                                │    ││
│  │  │                                                                  │    ││
│  │  │  缺点:                                                           │    ││
│  │  │  - 存在短暂不一致窗口                                            │    ││
│  │  │  - 删除缓存失败需要重试                                          │    ││
│  │  │                                                                  │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  │                                                                          ││
│  │  为什么是"先更新DB再删除缓存"而不是"先删除缓存再更新DB"?                 ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │                                                                  │    ││
│  │  │  先删除缓存的问题:                                               │    ││
│  │  │  T1: 删除缓存                                                    │    ││
│  │  │  T2: 读取缓存未命中，从DB读取旧值，写入缓存                       │    ││
│  │  │  T1: 更新DB                                                      │    ││
│  │  │  结果: 缓存中是旧值，DB中是新值 → 不一致!                        │    ││
│  │  │                                                                  │    ││
│  │  │  先更新DB的问题 (概率较低):                                      │    ││
│  │  │  T1: 更新DB                                                      │    ││
│  │  │  T2: 读取缓存命中，返回旧值                                      │    ││
│  │  │  T1: 删除缓存                                                    │    ││
│  │  │  结果: T2读到旧值，但缓存很快被删除，后续请求会读到新值           │    ││
│  │  │                                                                  │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  2. 缓存穿透防护                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  问题: 查询不存在的数据，每次都穿透到数据库                              ││
│  │                                                                          ││
│  │  解决方案:                                                               ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │ // 允许缓存null值                                                │    ││
│  │  │ cacheManager.setAllowNullValues(true);                          │    ││
│  │  │                                                                  │    ││
│  │  │ // 或使用空对象模式                                              │    ││
│  │  │ @Cacheable(value = "users", key = "#id",                        │    ││
│  │  │            unless = "#result == null")                          │    ││
│  │  │ public User getUser(Long id) {                                  │    ││
│  │  │     return userRepository.findById(id)                          │    ││
│  │  │         .orElse(User.EMPTY);  // 返回空对象而非null              │    ││
│  │  │ }                                                               │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  3. 缓存雪崩防护                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  问题: 大量缓存同时过期，导致请求全部打到数据库                          ││
│  │                                                                          ││
│  │  解决方案:                                                               ││
│  │  - 不同缓存区域使用不同TTL (已实现)                                      ││
│  │  - 添加随机过期时间偏移                                                  ││
│  │  - 使用多级缓存 (L1 Caffeine + L2 Redis)                                ││
│  │  - 热点数据永不过期，后台异步更新                                        ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  4. 缓存击穿防护                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  问题: 热点key过期瞬间，大量请求同时查询数据库                           ││
│  │                                                                          ││
│  │  解决方案:                                                               ││
│  │  - 使用互斥锁 (分布式锁)                                                 ││
│  │  - 热点数据永不过期                                                      ││
│  │  - 提前异步刷新                                                          ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 6.6 缓存监控与统计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        缓存监控与统计                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Caffeine 缓存统计:                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  // 获取缓存统计                                                         ││
│  │  public static Map<String, CacheStats> getCacheStats(CacheManager mgr) { ││
│  │      Map<String, CacheStats> statsMap = new HashMap<>();                ││
│  │      if (mgr instanceof CaffeineCacheManager caffeineMgr) {             ││
│  │          for (String name : caffeineMgr.getCacheNames()) {              ││
│  │              var cache = caffeineMgr.getCache(name);                    ││
│  │              if (cache != null) {                                       ││
│  │                  var nativeCache = cache.getNativeCache();              ││
│  │                  if (nativeCache instanceof Cache<?, ?> caffeineCache) {││
│  │                      statsMap.put(name, caffeineCache.stats());         ││
│  │                  }                                                      ││
│  │              }                                                          ││
│  │          }                                                              ││
│  │      }                                                                  ││
│  │      return statsMap;                                                   ││
│  │  }                                                                      ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  统计指标说明:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 指标                │ 说明                    │ 健康阈值               ││
│  │ ───────────────────┼────────────────────────┼─────────────────────── ││
│  │ hitCount           │ 缓存命中次数            │ -                      ││
│  │ missCount          │ 缓存未命中次数          │ -                      ││
│  │ hitRate            │ 命中率                  │ > 80%                  ││
│  │ loadSuccessCount   │ 加载成功次数            │ -                      ││
│  │ loadFailureCount   │ 加载失败次数            │ < 1%                   ││
│  │ totalLoadTime      │ 总加载时间              │ -                      ││
│  │ evictionCount      │ 驱逐次数                │ 监控趋势               ││
│  │ evictionWeight     │ 驱逐权重                │ -                      ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  缓存统计 API:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  GET /api/v1/admin/cache/stats                                          ││
│  │                                                                          ││
│  │  响应示例:                                                               ││
│  │  {                                                                      ││
│  │    "caches": {                                                          ││
│  │      "users": {                                                         ││
│  │        "hitCount": 15234,                                               ││
│  │        "missCount": 1523,                                               ││
│  │        "hitRate": 0.909,                                                ││
│  │        "evictionCount": 234,                                            ││
│  │        "size": 856                                                      ││
│  │      },                                                                 ││
│  │      "trainingRecords": {                                               ││
│  │        "hitCount": 8765,                                                ││
│  │        "missCount": 2341,                                               ││
│  │        "hitRate": 0.789,                                                ││
│  │        "evictionCount": 567,                                            ││
│  │        "size": 1000                                                     ││
│  │      }                                                                  ││
│  │    },                                                                   ││
│  │    "totalHitRate": 0.856,                                               ││
│  │    "timestamp": "2026-01-08T10:30:00"                                   ││
│  │  }                                                                      ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 监控与可观测性

### 7.1 监控架构概述

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          监控架构概述                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                        监控数据流                                        ││
│  │                                                                          ││
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  ││
│  │  │ Application │───►│  Actuator   │───►│ Prometheus  │                  ││
│  │  │  (指标产生)  │    │  (指标暴露)  │    │  (指标收集)  │                  ││
│  │  └─────────────┘    └─────────────┘    └──────┬──────┘                  ││
│  │                                               │                          ││
│  │                                               ▼                          ││
│  │                                        ┌─────────────┐                  ││
│  │                                        │   Grafana   │                  ││
│  │                                        │  (可视化)    │                  ││
│  │                                        └─────────────┘                  ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  技术栈:                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 组件              │ 版本        │ 用途                                  ││
│  │ ─────────────────┼────────────┼───────────────────────────────────── ││
│  │ Spring Actuator  │ 3.2.x      │ 应用健康检查、指标暴露                 ││
│  │ Micrometer       │ 1.12.x     │ 应用指标收集                          ││
│  │ Prometheus       │ 2.x        │ 时序数据库、指标存储                   ││
│  │ Grafana          │ 10.x       │ 数据可视化、告警                       ││
│  │ Logback          │ 1.4.x      │ 日志框架                              ││
│  │ Logstash Encoder │ 7.4        │ JSON格式日志                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 7.2 Spring Actuator 端点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Spring Actuator 端点配置                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  配置 (application.properties):                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ # Actuator 端点配置                                                      ││
│  │ management.endpoints.web.exposure.include=health,info,metrics,prometheus││
│  │ management.endpoint.health.show-details=when_authorized                 ││
│  │ management.endpoint.health.probes.enabled=true                          ││
│  │                                                                          ││
│  │ # Prometheus 端点                                                        ││
│  │ management.prometheus.metrics.export.enabled=true                       ││
│  │                                                                          ││
│  │ # 健康检查配置                                                           ││
│  │ management.health.db.enabled=true                                       ││
│  │ management.health.redis.enabled=true                                    ││
│  │ management.health.diskspace.enabled=true                                ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  可用端点:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 端点                        │ 说明                                      ││
│  │ ──────────────────────────┼────────────────────────────────────────── ││
│  │ /actuator/health          │ 应用健康状态                               ││
│  │ /actuator/health/liveness │ 存活探针 (K8s)                             ││
│  │ /actuator/health/readiness│ 就绪探针 (K8s)                             ││
│  │ /actuator/info            │ 应用信息                                   ││
│  │ /actuator/metrics         │ 应用指标列表                               ││
│  │ /actuator/metrics/{name}  │ 具体指标值                                 ││
│  │ /actuator/prometheus      │ Prometheus格式指标                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  健康检查响应示例:                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ GET /actuator/health                                                    ││
│  │                                                                          ││
│  │ {                                                                       ││
│  │   "status": "UP",                                                       ││
│  │   "components": {                                                       ││
│  │     "db": {                                                             ││
│  │       "status": "UP",                                                   ││
│  │       "details": {                                                      ││
│  │         "database": "MySQL",                                            ││
│  │         "validationQuery": "isValid()"                                  ││
│  │       }                                                                 ││
│  │     },                                                                  ││
│  │     "diskSpace": {                                                      ││
│  │       "status": "UP",                                                   ││
│  │       "details": {                                                      ││
│  │         "total": 500107862016,                                          ││
│  │         "free": 350000000000,                                           ││
│  │         "threshold": 10485760                                           ││
│  │       }                                                                 ││
│  │     },                                                                  ││
│  │     "ping": {                                                           ││
│  │       "status": "UP"                                                    ││
│  │     }                                                                   ││
│  │   }                                                                     ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 自定义健康检查

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        自定义健康检查                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  数据库健康检查 (DatabaseHealthIndicator):                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Component                                                              ││
│  │ public class DatabaseHealthIndicator implements HealthIndicator {       ││
│  │                                                                          ││
│  │     @Autowired                                                          ││
│  │     private DataSource dataSource;                                      ││
│  │                                                                          ││
│  │     @Override                                                           ││
│  │     public Health health() {                                            ││
│  │         try (Connection conn = dataSource.getConnection()) {            ││
│  │             if (conn.isValid(5)) {                                      ││
│  │                 // 获取连接池状态                                        ││
│  │                 HikariDataSource hikari = (HikariDataSource) dataSource;││
│  │                 HikariPoolMXBean pool = hikari.getHikariPoolMXBean();   ││
│  │                                                                          ││
│  │                 return Health.up()                                      ││
│  │                     .withDetail("database", "MySQL")                    ││
│  │                     .withDetail("activeConnections", pool.getActiveConnections())││
│  │                     .withDetail("idleConnections", pool.getIdleConnections())││
│  │                     .withDetail("totalConnections", pool.getTotalConnections())││
│  │                     .withDetail("threadsAwaitingConnection",            ││
│  │                                 pool.getThreadsAwaitingConnection())    ││
│  │                     .build();                                           ││
│  │             }                                                           ││
│  │         } catch (SQLException e) {                                      ││
│  │             return Health.down()                                        ││
│  │                 .withDetail("error", e.getMessage())                    ││
│  │                 .build();                                               ││
│  │         }                                                               ││
│  │         return Health.down().build();                                   ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  连接池状态模型:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ public class ConnectionPoolStatus {                                     ││
│  │     private int activeConnections;      // 活跃连接数                   ││
│  │     private int idleConnections;        // 空闲连接数                   ││
│  │     private int totalConnections;       // 总连接数                     ││
│  │     private int threadsAwaitingConnection; // 等待连接的线程数          ││
│  │     private int maxPoolSize;            // 最大连接池大小               ││
│  │     private String status;              // 状态: HEALTHY/WARNING/CRITICAL││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 7.4 Micrometer 指标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Micrometer 指标体系                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  内置指标:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 类别              │ 指标名称                      │ 说明                ││
│  │ ─────────────────┼─────────────────────────────┼─────────────────── ││
│  │ JVM              │ jvm.memory.used              │ JVM内存使用         ││
│  │                  │ jvm.memory.max               │ JVM最大内存         ││
│  │                  │ jvm.gc.pause                 │ GC暂停时间          ││
│  │                  │ jvm.threads.live             │ 活跃线程数          ││
│  │ ─────────────────┼─────────────────────────────┼─────────────────── ││
│  │ HTTP             │ http.server.requests        │ HTTP请求统计        ││
│  │                  │ http.server.requests.active │ 活跃请求数          ││
│  │ ─────────────────┼─────────────────────────────┼─────────────────── ││
│  │ 数据库           │ hikaricp.connections.active │ 活跃连接数          ││
│  │                  │ hikaricp.connections.idle   │ 空闲连接数          ││
│  │                  │ hikaricp.connections.pending│ 等待连接数          ││
│  │                  │ hikaricp.connections.timeout│ 连接超时数          ││
│  │ ─────────────────┼─────────────────────────────┼─────────────────── ││
│  │ 缓存             │ cache.gets                  │ 缓存获取次数        ││
│  │                  │ cache.puts                  │ 缓存写入次数        ││
│  │                  │ cache.evictions             │ 缓存驱逐次数        ││
│  │ ─────────────────┼─────────────────────────────┼─────────────────── ││
│  │ 系统             │ system.cpu.usage            │ CPU使用率           ││
│  │                  │ system.load.average.1m      │ 1分钟负载           ││
│  │                  │ disk.free                   │ 磁盘剩余空间        ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  自定义指标示例:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Component                                                              ││
│  │ public class BusinessMetrics {                                          ││
│  │                                                                          ││
│  │     private final Counter loginCounter;                                 ││
│  │     private final Timer apiTimer;                                       ││
│  │     private final Gauge activeUsers;                                    ││
│  │                                                                          ││
│  │     public BusinessMetrics(MeterRegistry registry) {                    ││
│  │         // 计数器: 登录次数                                              ││
│  │         this.loginCounter = Counter.builder("fitness.login.count")      ││
│  │             .description("Total login attempts")                        ││
│  │             .tag("type", "user")                                        ││
│  │             .register(registry);                                        ││
│  │                                                                          ││
│  │         // 计时器: API响应时间                                           ││
│  │         this.apiTimer = Timer.builder("fitness.api.duration")           ││
│  │             .description("API response time")                           ││
│  │             .register(registry);                                        ││
│  │                                                                          ││
│  │         // 仪表: 活跃用户数                                              ││
│  │         this.activeUsers = Gauge.builder("fitness.users.active",        ││
│  │                 this::getActiveUserCount)                               ││
│  │             .description("Current active users")                        ││
│  │             .register(registry);                                        ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     public void recordLogin() {                                         ││
│  │         loginCounter.increment();                                       ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     public void recordApiCall(Runnable operation) {                     ││
│  │         apiTimer.record(operation);                                     ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.5 日志架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          日志架构                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  日志级别配置:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ # application.properties                                                ││
│  │ logging.level.root=INFO                                                 ││
│  │ logging.level.com.wzl.fitness=DEBUG                                     ││
│  │ logging.level.org.springframework.security=DEBUG                        ││
│  │ logging.level.org.hibernate.SQL=DEBUG                                   ││
│  │ logging.level.org.hibernate.type.descriptor.sql=TRACE                   ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  日志格式 (JSON - 生产环境):                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ <!-- logback-spring.xml -->                                             ││
│  │ <configuration>                                                         ││
│  │     <springProfile name="prod">                                         ││
│  │         <appender name="JSON" class="ch.qos.logback.core.ConsoleAppender">││
│  │             <encoder class="net.logstash.logback.encoder.              ││
│  │                            LogstashEncoder">                            ││
│  │                 <includeMdcKeyName>userId</includeMdcKeyName>           ││
│  │                 <includeMdcKeyName>requestId</includeMdcKeyName>        ││
│  │             </encoder>                                                  ││
│  │         </appender>                                                     ││
│  │     </springProfile>                                                    ││
│  │ </configuration>                                                        ││
│  │                                                                          ││
│  │ 输出示例:                                                                ││
│  │ {                                                                       ││
│  │   "@timestamp": "2026-01-08T10:30:00.123Z",                             ││
│  │   "level": "INFO",                                                      ││
│  │   "logger_name": "com.wzl.fitness.service.TrainingService",             ││
│  │   "message": "Training record created",                                 ││
│  │   "userId": "123",                                                      ││
│  │   "requestId": "abc-123-def",                                           ││
│  │   "thread_name": "http-nio-8080-exec-1"                                 ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  日志工具类:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ public class LoggingUtils {                                             ││
│  │                                                                          ││
│  │     // 设置请求上下文                                                    ││
│  │     public static void setRequestContext(String requestId, Long userId) {││
│  │         MDC.put("requestId", requestId);                                ││
│  │         MDC.put("userId", String.valueOf(userId));                      ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     // 清除请求上下文                                                    ││
│  │     public static void clearRequestContext() {                          ││
│  │         MDC.clear();                                                    ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     // 记录操作日志                                                      ││
│  │     public static void logOperation(String operation, Object... args) { ││
│  │         log.info("Operation: {} - Args: {}", operation, args);          ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


---

## 8. 部署架构

### 8.1 部署架构概述

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          部署架构概述                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  开发环境:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  ││
│  │  │ Frontend    │    │ Backend     │    │ MySQL       │                  ││
│  │  │ Vite Dev    │───►│ Spring Boot │───►│ Docker      │                  ││
│  │  │ :3001/:3002 │    │ :8080       │    │ :3306       │                  ││
│  │  └─────────────┘    └─────────────┘    └─────────────┘                  ││
│  │                                                                          ││
│  │  特点:                                                                   ││
│  │  - 热重载支持                                                            ││
│  │  - 详细日志输出                                                          ││
│  │  - 调试模式启用                                                          ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  生产环境:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │                         ┌─────────────┐                                 ││
│  │                         │   Nginx     │                                 ││
│  │                         │  (反向代理)  │                                 ││
│  │                         └──────┬──────┘                                 ││
│  │                                │                                         ││
│  │              ┌─────────────────┼─────────────────┐                      ││
│  │              │                 │                 │                      ││
│  │              ▼                 ▼                 ▼                      ││
│  │  ┌─────────────────┐  ┌─────────────┐  ┌─────────────────┐             ││
│  │  │ Static Files    │  │ API Server  │  │ Admin Static    │             ││
│  │  │ (Frontend)      │  │ (Backend)   │  │ (Admin Panel)   │             ││
│  │  └─────────────────┘  └──────┬──────┘  └─────────────────┘             ││
│  │                              │                                          ││
│  │              ┌───────────────┼───────────────┐                          ││
│  │              │               │               │                          ││
│  │              ▼               ▼               ▼                          ││
│  │  ┌─────────────────┐  ┌─────────────┐  ┌─────────────────┐             ││
│  │  │     MySQL       │  │    Redis    │  │   Prometheus    │             ││
│  │  │   (主数据库)     │  │   (缓存)    │  │    (监控)       │             ││
│  │  └─────────────────┘  └─────────────┘  └─────────────────┘             ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Docker 容器化

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Docker 容器化配置                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Dockerfile (后端):                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ # 多阶段构建                                                             ││
│  │ FROM maven:3.9-eclipse-temurin-17 AS builder                            ││
│  │ WORKDIR /app                                                            ││
│  │ COPY pom.xml .                                                          ││
│  │ RUN mvn dependency:go-offline                                           ││
│  │ COPY src ./src                                                          ││
│  │ RUN mvn package -DskipTests                                             ││
│  │                                                                          ││
│  │ # 运行阶段                                                               ││
│  │ FROM eclipse-temurin:17-jre-alpine                                      ││
│  │ WORKDIR /app                                                            ││
│  │                                                                          ││
│  │ # 创建非root用户                                                         ││
│  │ RUN addgroup -S spring && adduser -S spring -G spring                   ││
│  │ USER spring:spring                                                      ││
│  │                                                                          ││
│  │ COPY --from=builder /app/target/*.jar app.jar                           ││
│  │                                                                          ││
│  │ # JVM 优化参数                                                           ││
│  │ ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC"                         ││
│  │                                                                          ││
│  │ EXPOSE 8080                                                             ││
│  │ ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]                 ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  docker-compose.yml:                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ version: '3.8'                                                          ││
│  │                                                                          ││
│  │ services:                                                               ││
│  │   mysql:                                                                ││
│  │     image: mysql:8.0                                                    ││
│  │     environment:                                                        ││
│  │       MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}                               ││
│  │       MYSQL_DATABASE: fitness                                           ││
│  │     volumes:                                                            ││
│  │       - mysql_data:/var/lib/mysql                                       ││
│  │       - ./docker/mysql/init:/docker-entrypoint-initdb.d                 ││
│  │     ports:                                                              ││
│  │       - "3306:3306"                                                     ││
│  │     healthcheck:                                                        ││
│  │       test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]            ││
│  │       interval: 10s                                                     ││
│  │       timeout: 5s                                                       ││
│  │       retries: 5                                                        ││
│  │                                                                          ││
│  │   backend:                                                              ││
│  │     build: .                                                            ││
│  │     environment:                                                        ││
│  │       SPRING_PROFILES_ACTIVE: prod                                      ││
│  │       DB_HOST: mysql                                                    ││
│  │       DB_PASSWORD: ${DB_PASSWORD}                                       ││
│  │     ports:                                                              ││
│  │       - "8080:8080"                                                     ││
│  │     depends_on:                                                         ││
│  │       mysql:                                                            ││
│  │         condition: service_healthy                                      ││
│  │                                                                          ││
│  │   redis:                                                                ││
│  │     image: redis:7-alpine                                               ││
│  │     ports:                                                              ││
│  │       - "6379:6379"                                                     ││
│  │     volumes:                                                            ││
│  │       - redis_data:/data                                                ││
│  │                                                                          ││
│  │ volumes:                                                                ││
│  │   mysql_data:                                                           ││
│  │   redis_data:                                                           ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 8.3 Nginx 配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Nginx 配置                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  nginx.conf:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ upstream backend {                                                      ││
│  │     server backend:8080;                                                ││
│  │     keepalive 32;                                                       ││
│  │ }                                                                       ││
│  │                                                                          ││
│  │ server {                                                                ││
│  │     listen 80;                                                          ││
│  │     server_name fitness.example.com;                                    ││
│  │                                                                          ││
│  │     # 重定向到HTTPS                                                      ││
│  │     return 301 https://$server_name$request_uri;                        ││
│  │ }                                                                       ││
│  │                                                                          ││
│  │ server {                                                                ││
│  │     listen 443 ssl http2;                                               ││
│  │     server_name fitness.example.com;                                    ││
│  │                                                                          ││
│  │     # SSL 配置                                                           ││
│  │     ssl_certificate /etc/nginx/ssl/cert.pem;                            ││
│  │     ssl_certificate_key /etc/nginx/ssl/key.pem;                         ││
│  │     ssl_protocols TLSv1.2 TLSv1.3;                                      ││
│  │     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:...;                      ││
│  │                                                                          ││
│  │     # 安全头                                                             ││
│  │     add_header X-Frame-Options "SAMEORIGIN" always;                     ││
│  │     add_header X-Content-Type-Options "nosniff" always;                 ││
│  │     add_header X-XSS-Protection "1; mode=block" always;                 ││
│  │                                                                          ││
│  │     # Gzip 压缩                                                          ││
│  │     gzip on;                                                            ││
│  │     gzip_types text/plain application/json application/javascript;     ││
│  │                                                                          ││
│  │     # 前端静态文件                                                       ││
│  │     location / {                                                        ││
│  │         root /usr/share/nginx/html/frontend;                            ││
│  │         try_files $uri $uri/ /index.html;                               ││
│  │         expires 1d;                                                     ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     # 管理端静态文件                                                     ││
│  │     location /admin {                                                   ││
│  │         alias /usr/share/nginx/html/admin;                              ││
│  │         try_files $uri $uri/ /admin/index.html;                         ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     # API 代理                                                           ││
│  │     location /api {                                                     ││
│  │         proxy_pass http://backend;                                      ││
│  │         proxy_http_version 1.1;                                         ││
│  │         proxy_set_header Host $host;                                    ││
│  │         proxy_set_header X-Real-IP $remote_addr;                        ││
│  │         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    ││
│  │         proxy_set_header X-Forwarded-Proto $scheme;                     ││
│  │         proxy_connect_timeout 30s;                                      ││
│  │         proxy_read_timeout 60s;                                         ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     # Actuator 端点 (仅内网访问)                                         ││
│  │     location /actuator {                                                ││
│  │         allow 10.0.0.0/8;                                               ││
│  │         deny all;                                                       ││
│  │         proxy_pass http://backend;                                      ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.4 环境配置管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        环境配置管理                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  配置文件结构:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ src/main/resources/                                                     ││
│  │ ├── application.properties          # 通用配置                          ││
│  │ ├── application-dev.properties      # 开发环境                          ││
│  │ ├── application-test.properties     # 测试环境                          ││
│  │ └── application-prod.properties     # 生产环境                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  环境变量配置:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ # application.properties                                                ││
│  │                                                                          ││
│  │ # 数据库配置 (使用环境变量)                                              ││
│  │ spring.datasource.url=jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/fitness││
│  │ spring.datasource.username=${DB_USERNAME:root}                          ││
│  │ spring.datasource.password=${DB_PASSWORD:password}                      ││
│  │                                                                          ││
│  │ # Redis 配置                                                             ││
│  │ spring.data.redis.host=${REDIS_HOST:localhost}                          ││
│  │ spring.data.redis.port=${REDIS_PORT:6379}                               ││
│  │ spring.data.redis.password=${REDIS_PASSWORD:}                           ││
│  │                                                                          ││
│  │ # JWT 配置                                                               ││
│  │ jwt.secret=${JWT_SECRET:your-secret-key}                                ││
│  │ jwt.expiration=${JWT_EXPIRATION:86400000}                               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  敏感配置管理:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  开发环境:                                                               ││
│  │  - 使用 .env 文件 (不提交到Git)                                          ││
│  │  - 使用默认值                                                            ││
│  │                                                                          ││
│  │  生产环境:                                                               ││
│  │  - 使用环境变量                                                          ││
│  │  - 使用 Docker Secrets                                                   ││
│  │  - 使用 Kubernetes Secrets                                               ││
│  │  - 使用云服务密钥管理 (AWS Secrets Manager等)                            ││
│  │                                                                          ││
│  │  .env 文件示例:                                                          ││
│  │  ┌─────────────────────────────────────────────────────────────────┐    ││
│  │  │ DB_HOST=localhost                                                │    ││
│  │  │ DB_PORT=3306                                                     │    ││
│  │  │ DB_USERNAME=root                                                 │    ││
│  │  │ DB_PASSWORD=your_secure_password                                 │    ││
│  │  │ JWT_SECRET=your_jwt_secret_key_at_least_256_bits                 │    ││
│  │  │ REDIS_HOST=localhost                                             │    ││
│  │  │ REDIS_PORT=6379                                                  │    ││
│  │  └─────────────────────────────────────────────────────────────────┘    ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 8.5 优雅关闭机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        优雅关闭机制                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  配置类: GracefulShutdownConfig.java                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Configuration                                                          ││
│  │ public class GracefulShutdownConfig {                                   ││
│  │                                                                          ││
│  │     @Bean                                                               ││
│  │     public GracefulShutdown gracefulShutdown() {                        ││
│  │         return new GracefulShutdown();                                  ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     @Bean                                                               ││
│  │     public ConfigurableServletWebServerFactory webServerFactory(        ││
│  │             GracefulShutdown gracefulShutdown) {                        ││
│  │         TomcatServletWebServerFactory factory =                         ││
│  │             new TomcatServletWebServerFactory();                        ││
│  │         factory.addConnectorCustomizers(gracefulShutdown);              ││
│  │         return factory;                                                 ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  关闭流程:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  1. 收到 SIGTERM 信号                                                    ││
│  │     │                                                                    ││
│  │     ▼                                                                    ││
│  │  2. 停止接收新请求                                                       ││
│  │     │                                                                    ││
│  │     ▼                                                                    ││
│  │  3. 等待现有请求完成 (最多30秒)                                          ││
│  │     │                                                                    ││
│  │     ▼                                                                    ││
│  │  4. 关闭数据库连接池                                                     ││
│  │     │                                                                    ││
│  │     ▼                                                                    ││
│  │  5. 关闭缓存连接                                                         ││
│  │     │                                                                    ││
│  │     ▼                                                                    ││
│  │  6. 应用完全关闭                                                         ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  配置参数:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ # application.properties                                                ││
│  │ server.shutdown=graceful                                                ││
│  │ spring.lifecycle.timeout-per-shutdown-phase=30s                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 核心算法与业务逻辑

### 9.1 1RM (单次最大重量) 计算

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        1RM 计算算法                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  什么是 1RM?                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 1RM (One Repetition Maximum) 是指在正确姿势下，                          ││
│  │ 一个人能够举起的最大重量，只能完成一次。                                  ││
│  │                                                                          ││
│  │ 用途:                                                                    ││
│  │ - 评估力量水平                                                           ││
│  │ - 制定训练计划 (如: 使用70% 1RM进行训练)                                 ││
│  │ - 追踪进步                                                               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  计算公式 (Epley公式):                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  1RM = weight × (1 + reps / 30)                                         ││
│  │                                                                          ││
│  │  其中:                                                                   ││
│  │  - weight: 实际使用的重量 (kg)                                           ││
│  │  - reps: 完成的次数                                                      ││
│  │                                                                          ││
│  │  示例:                                                                   ││
│  │  - 使用 100kg 完成 10 次                                                 ││
│  │  - 1RM = 100 × (1 + 10/30) = 100 × 1.333 = 133.3kg                      ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  代码实现:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ public class OneRepMaxCalculator {                                      ││
│  │                                                                          ││
│  │     /**                                                                 ││
│  │      * 使用 Epley 公式计算 1RM                                           ││
│  │      * @param weight 使用的重量 (kg)                                     ││
│  │      * @param reps 完成的次数                                            ││
│  │      * @return 预估的 1RM                                                ││
│  │      */                                                                 ││
│  │     public static double calculateEpley(double weight, int reps) {      ││
│  │         if (reps == 1) return weight;                                   ││
│  │         if (reps <= 0 || weight <= 0) return 0;                         ││
│  │         return weight * (1 + reps / 30.0);                              ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     /**                                                                 ││
│  │      * 使用 Brzycki 公式计算 1RM (更保守)                                ││
│  │      */                                                                 ││
│  │     public static double calculateBrzycki(double weight, int reps) {    ││
│  │         if (reps == 1) return weight;                                   ││
│  │         if (reps <= 0 || weight <= 0 || reps > 12) return 0;            ││
│  │         return weight * (36.0 / (37.0 - reps));                         ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     /**                                                                 ││
│  │      * 计算训练重量百分比                                                ││
│  │      * @param oneRepMax 1RM值                                           ││
│  │      * @param percentage 百分比 (0.0-1.0)                                ││
│  │      */                                                                 ││
│  │     public static double calculateTrainingWeight(                       ││
│  │             double oneRepMax, double percentage) {                      ││
│  │         return oneRepMax * percentage;                                  ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  训练强度参考:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 百分比      │ 次数范围    │ 训练目标                                    ││
│  │ ───────────┼────────────┼────────────────────────────────────────── ││
│  │ 90-100%    │ 1-3次      │ 最大力量                                    ││
│  │ 80-90%     │ 3-6次      │ 力量增长                                    ││
│  │ 70-80%     │ 6-12次     │ 肌肉增长 (增肌)                             ││
│  │ 60-70%     │ 12-20次    │ 肌肉耐力                                    ││
│  │ <60%       │ 20+次      │ 热身/恢复                                   ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 9.2 训练容量计算

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        训练容量计算                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  训练容量 (Volume) 定义:                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  Volume = 组数 × 次数 × 重量                                             ││
│  │                                                                          ││
│  │  示例:                                                                   ││
│  │  - 深蹲: 4组 × 8次 × 100kg = 3200kg                                     ││
│  │  - 卧推: 3组 × 10次 × 80kg = 2400kg                                     ││
│  │  - 总容量: 5600kg                                                        ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  代码实现:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Service                                                                ││
│  │ public class TrainingVolumeService {                                    ││
│  │                                                                          ││
│  │     /**                                                                 ││
│  │      * 计算单个动作的训练容量                                            ││
│  │      */                                                                 ││
│  │     public double calculateExerciseVolume(                              ││
│  │             int sets, int reps, double weight) {                        ││
│  │         return sets * reps * weight;                                    ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     /**                                                                 ││
│  │      * 计算训练记录的总容量                                              ││
│  │      */                                                                 ││
│  │     public double calculateTotalVolume(TrainingRecord record) {         ││
│  │         return record.getExerciseDetails().stream()                     ││
│  │             .mapToDouble(detail ->                                      ││
│  │                 detail.getSets() * detail.getReps() * detail.getWeight())││
│  │             .sum();                                                     ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     /**                                                                 ││
│  │      * 计算周训练容量                                                    ││
│  │      */                                                                 ││
│  │     public Map<String, Double> calculateWeeklyVolume(                   ││
│  │             Long userId, LocalDate weekStart) {                         ││
│  │         List<TrainingRecord> records = repository                       ││
│  │             .findByUserIdAndDateBetween(userId,                         ││
│  │                 weekStart, weekStart.plusDays(7));                      ││
│  │                                                                          ││
│  │         return records.stream()                                         ││
│  │             .flatMap(r -> r.getExerciseDetails().stream())              ││
│  │             .collect(Collectors.groupingBy(                             ││
│  │                 ExerciseDetail::getExerciseName,                        ││
│  │                 Collectors.summingDouble(d ->                           ││
│  │                     d.getSets() * d.getReps() * d.getWeight())          ││
│  │             ));                                                         ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  容量进阶建议:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 训练水平    │ 每周每肌群组数  │ 说明                                    ││
│  │ ───────────┼───────────────┼────────────────────────────────────── ││
│  │ 新手       │ 10-12组        │ 适应期，避免过度训练                    ││
│  │ 中级       │ 12-18组        │ 可以承受更多训练量                      ││
│  │ 高级       │ 18-25组        │ 需要更多刺激才能进步                    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.3 恢复评估算法

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        恢复评估算法                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  评估因素:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 因素              │ 权重    │ 评分范围  │ 说明                          ││
│  │ ─────────────────┼────────┼──────────┼───────────────────────────── ││
│  │ 睡眠时长          │ 30%    │ 0-100    │ 7-9小时为最佳                 ││
│  │ 睡眠质量          │ 20%    │ 0-100    │ 主观评分                      ││
│  │ 肌肉酸痛程度      │ 25%    │ 0-100    │ 1-10分反转                    ││
│  │ 压力水平          │ 15%    │ 0-100    │ 1-10分反转                    ││
│  │ 心率变异性(HRV)   │ 10%    │ 0-100    │ 可选指标                      ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  代码实现:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Service                                                                ││
│  │ public class RecoveryAssessmentService {                                ││
│  │                                                                          ││
│  │     private static final double SLEEP_WEIGHT = 0.30;                    ││
│  │     private static final double SLEEP_QUALITY_WEIGHT = 0.20;            ││
│  │     private static final double SORENESS_WEIGHT = 0.25;                 ││
│  │     private static final double STRESS_WEIGHT = 0.15;                   ││
│  │     private static final double HRV_WEIGHT = 0.10;                      ││
│  │                                                                          ││
│  │     public RecoveryScore calculateRecoveryScore(RecoveryData data) {    ││
│  │         // 睡眠时长评分 (7-9小时最佳)                                    ││
│  │         double sleepScore = calculateSleepScore(data.getSleepHours());  ││
│  │                                                                          ││
│  │         // 睡眠质量评分 (1-10 → 0-100)                                   ││
│  │         double sleepQualityScore = data.getSleepQuality() * 10;         ││
│  │                                                                          ││
│  │         // 肌肉酸痛评分 (反转: 10分酸痛 → 0分恢复)                       ││
│  │         double sorenessScore = (10 - data.getMuscleSoreness()) * 10;    ││
│  │                                                                          ││
│  │         // 压力评分 (反转)                                               ││
│  │         double stressScore = (10 - data.getStressLevel()) * 10;         ││
│  │                                                                          ││
│  │         // HRV评分 (如果有)                                              ││
│  │         double hrvScore = data.getHrv() != null ?                       ││
│  │             calculateHrvScore(data.getHrv()) : 50;                      ││
│  │                                                                          ││
│  │         // 加权计算总分                                                  ││
│  │         double totalScore =                                             ││
│  │             sleepScore * SLEEP_WEIGHT +                                 ││
│  │             sleepQualityScore * SLEEP_QUALITY_WEIGHT +                  ││
│  │             sorenessScore * SORENESS_WEIGHT +                           ││
│  │             stressScore * STRESS_WEIGHT +                               ││
│  │             hrvScore * HRV_WEIGHT;                                      ││
│  │                                                                          ││
│  │         return new RecoveryScore(totalScore, getRecommendation(totalScore));││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     private double calculateSleepScore(double hours) {                  ││
│  │         if (hours >= 7 && hours <= 9) return 100;                       ││
│  │         if (hours >= 6 && hours < 7) return 70;                         ││
│  │         if (hours > 9 && hours <= 10) return 80;                        ││
│  │         if (hours >= 5 && hours < 6) return 50;                         ││
│  │         return 30;                                                      ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     private String getRecommendation(double score) {                    ││
│  │         if (score >= 80) return "状态极佳，可以进行高强度训练";           ││
│  │         if (score >= 60) return "状态良好，可以正常训练";                ││
│  │         if (score >= 40) return "状态一般，建议降低训练强度";            ││
│  │         return "需要休息，建议进行轻度活动或完全休息";                    ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 9.4 营养分析算法

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        营养分析算法                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  基础代谢率 (BMR) 计算:                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  Mifflin-St Jeor 公式 (最准确):                                          ││
│  │                                                                          ││
│  │  男性: BMR = 10 × 体重(kg) + 6.25 × 身高(cm) - 5 × 年龄 + 5             ││
│  │  女性: BMR = 10 × 体重(kg) + 6.25 × 身高(cm) - 5 × 年龄 - 161           ││
│  │                                                                          ││
│  │  示例 (男性, 75kg, 175cm, 25岁):                                         ││
│  │  BMR = 10 × 75 + 6.25 × 175 - 5 × 25 + 5                                ││
│  │      = 750 + 1093.75 - 125 + 5                                          ││
│  │      = 1723.75 kcal/天                                                  ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  每日总能量消耗 (TDEE):                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 活动水平          │ 系数    │ 说明                                      ││
│  │ ─────────────────┼────────┼────────────────────────────────────────── ││
│  │ 久坐不动          │ 1.2    │ 几乎不运动                                ││
│  │ 轻度活动          │ 1.375  │ 每周运动1-3天                             ││
│  │ 中度活动          │ 1.55   │ 每周运动3-5天                             ││
│  │ 高度活动          │ 1.725  │ 每周运动6-7天                             ││
│  │ 极高活动          │ 1.9    │ 每天高强度运动或体力劳动                  ││
│  │                                                                          ││
│  │ TDEE = BMR × 活动系数                                                   ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  宏量营养素分配:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 目标              │ 蛋白质    │ 碳水化合物  │ 脂肪                      ││
│  │ ─────────────────┼──────────┼────────────┼───────────────────────── ││
│  │ 增肌              │ 25-30%   │ 45-55%     │ 20-25%                    ││
│  │ 减脂              │ 30-35%   │ 35-45%     │ 25-30%                    ││
│  │ 维持              │ 20-25%   │ 45-55%     │ 25-30%                    ││
│  │ 耐力运动          │ 15-20%   │ 55-65%     │ 20-25%                    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  代码实现:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Service                                                                ││
│  │ public class NutritionCalculatorService {                               ││
│  │                                                                          ││
│  │     public NutritionPlan calculateDailyNeeds(UserProfile profile) {     ││
│  │         // 计算BMR                                                       ││
│  │         double bmr = calculateBMR(profile);                             ││
│  │                                                                          ││
│  │         // 计算TDEE                                                      ││
│  │         double tdee = bmr * getActivityMultiplier(profile.getActivityLevel());││
│  │                                                                          ││
│  │         // 根据目标调整热量                                              ││
│  │         double targetCalories = adjustForGoal(tdee, profile.getGoal()); ││
│  │                                                                          ││
│  │         // 计算宏量营养素                                                ││
│  │         MacroNutrients macros = calculateMacros(                        ││
│  │             targetCalories, profile.getGoal());                         ││
│  │                                                                          ││
│  │         return new NutritionPlan(targetCalories, macros);               ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     private double calculateBMR(UserProfile profile) {                  ││
│  │         double base = 10 * profile.getWeight()                          ││
│  │                     + 6.25 * profile.getHeight()                        ││
│  │                     - 5 * profile.getAge();                             ││
│  │         return profile.getGender() == Gender.MALE ? base + 5 : base - 161;││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     private double adjustForGoal(double tdee, FitnessGoal goal) {       ││
│  │         return switch (goal) {                                          ││
│  │             case MUSCLE_GAIN -> tdee + 300;  // 热量盈余                 ││
│  │             case FAT_LOSS -> tdee - 500;     // 热量赤字                 ││
│  │             case MAINTAIN -> tdee;           // 维持                     ││
│  │         };                                                              ││
│  │     }                                                                   ││
│  │                                                                          ││
│  │     private MacroNutrients calculateMacros(double calories, FitnessGoal goal) {││
│  │         double proteinRatio, carbRatio, fatRatio;                       ││
│  │                                                                          ││
│  │         switch (goal) {                                                 ││
│  │             case MUSCLE_GAIN -> {                                       ││
│  │                 proteinRatio = 0.30; carbRatio = 0.50; fatRatio = 0.20; ││
│  │             }                                                           ││
│  │             case FAT_LOSS -> {                                          ││
│  │                 proteinRatio = 0.35; carbRatio = 0.40; fatRatio = 0.25; ││
│  │             }                                                           ││
│  │             default -> {                                                ││
│  │                 proteinRatio = 0.25; carbRatio = 0.50; fatRatio = 0.25; ││
│  │             }                                                           ││
│  │         }                                                               ││
│  │                                                                          ││
│  │         return new MacroNutrients(                                      ││
│  │             (calories * proteinRatio) / 4,  // 蛋白质 4kcal/g           ││
│  │             (calories * carbRatio) / 4,     // 碳水 4kcal/g             ││
│  │             (calories * fatRatio) / 9       // 脂肪 9kcal/g             ││
│  │         );                                                              ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 9.5 数据库重试机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据库重试机制                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  重试策略: 指数退避 (Exponential Backoff)                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                                                                          ││
│  │  重试间隔 = 基础延迟 × 2^(重试次数-1)                                    ││
│  │                                                                          ││
│  │  示例 (基础延迟1秒):                                                     ││
│  │  - 第1次重试: 1秒后                                                      ││
│  │  - 第2次重试: 2秒后                                                      ││
│  │  - 第3次重试: 4秒后                                                      ││
│  │  - 第4次重试: 8秒后                                                      ││
│  │                                                                          ││
│  │  优点:                                                                   ││
│  │  - 避免立即重试造成的资源浪费                                            ││
│  │  - 给系统恢复时间                                                        ││
│  │  - 减少对故障服务的压力                                                  ││
│  │                                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  AOP 实现:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Aspect                                                                 ││
│  │ @Component                                                              ││
│  │ public class DatabaseRetryAspect {                                      ││
│  │                                                                          ││
│  │     private static final int MAX_RETRIES = 3;                           ││
│  │     private static final long BASE_DELAY_MS = 1000;                     ││
│  │                                                                          ││
│  │     @Around("@annotation(DatabaseRetryable)")                           ││
│  │     public Object retryOnFailure(ProceedingJoinPoint joinPoint)         ││
│  │             throws Throwable {                                          ││
│  │                                                                          ││
│  │         int attempts = 0;                                               ││
│  │         Exception lastException = null;                                 ││
│  │                                                                          ││
│  │         while (attempts < MAX_RETRIES) {                                ││
│  │             try {                                                       ││
│  │                 return joinPoint.proceed();                             ││
│  │             } catch (CannotGetJdbcConnectionException |                 ││
│  │                      TransientDataAccessException e) {                  ││
│  │                                                                          ││
│  │                 lastException = e;                                      ││
│  │                 attempts++;                                             ││
│  │                                                                          ││
│  │                 if (attempts < MAX_RETRIES) {                           ││
│  │                     long delay = BASE_DELAY_MS * (long) Math.pow(2, attempts - 1);││
│  │                     log.warn("数据库操作失败，{}ms后进行第{}次重试",     ││
│  │                              delay, attempts);                          ││
│  │                     Thread.sleep(delay);                                ││
│  │                 }                                                       ││
│  │             }                                                           ││
│  │         }                                                               ││
│  │                                                                          ││
│  │         log.error("数据库操作在{}次重试后仍然失败", MAX_RETRIES);        ││
│  │         throw lastException;                                            ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  使用方式:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ @Service                                                                ││
│  │ public class TrainingRecordServiceImpl {                                ││
│  │                                                                          ││
│  │     @DatabaseRetryable                                                  ││
│  │     @Transactional                                                      ││
│  │     public TrainingRecord save(TrainingRecord record) {                 ││
│  │         return repository.save(record);                                 ││
│  │     }                                                                   ││
│  │ }                                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  可重试异常类型:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 异常类型                              │ 说明                            ││
│  │ ─────────────────────────────────────┼──────────────────────────────── ││
│  │ CannotGetJdbcConnectionException     │ 无法获取数据库连接              ││
│  │ TransientDataAccessException         │ 临时性数据访问异常              ││
│  │ QueryTimeoutException                │ 查询超时                        ││
│  │ DeadlockLoserDataAccessException     │ 死锁                            ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 技术选型理由

### 10.1 后端技术选型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        后端技术选型理由                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Spring Boot 3.2.5                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 企业级应用的事实标准                                                   ││
│  │ ✓ 丰富的生态系统和社区支持                                               ││
│  │ ✓ 自动配置减少样板代码                                                   ││
│  │ ✓ 内置生产级特性 (Actuator, Security)                                   ││
│  │ ✓ 支持 Java 17 新特性                                                    ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - Quarkus: 启动更快，但生态不如Spring成熟                                ││
│  │ - Micronaut: 编译时DI，但学习曲线较陡                                    ││
│  │ - Node.js: 适合I/O密集型，但类型安全性不如Java                           ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Spring Data JPA                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 简化数据访问层开发                                                     ││
│  │ ✓ 方法名自动生成查询                                                     ││
│  │ ✓ 支持分页和排序                                                         ││
│  │ ✓ 与Spring生态无缝集成                                                   ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - MyBatis: 更灵活的SQL控制，但需要更多配置                               ││
│  │ - JOOQ: 类型安全的SQL，但学习成本较高                                    ││
│  │ - 原生JDBC: 最大控制权，但开发效率低                                     ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  MySQL 8.0                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 成熟稳定，广泛使用                                                     ││
│  │ ✓ 丰富的工具和文档                                                       ││
│  │ ✓ 支持JSON数据类型                                                       ││
│  │ ✓ 窗口函数支持                                                           ││
│  │ ✓ 免费开源                                                               ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - PostgreSQL: 功能更强大，但MySQL更普及                                  ││
│  │ - MongoDB: 适合非结构化数据，但本项目数据结构明确                        ││
│  │ - SQLite: 轻量级，但不适合生产环境                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Caffeine + Redis 缓存                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ Caffeine: 最快的JVM本地缓存                                            ││
│  │ ✓ Redis: 分布式缓存，支持持久化                                          ││
│  │ ✓ 多级缓存提高命中率                                                     ││
│  │ ✓ 降低数据库压力                                                         ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - Ehcache: 功能丰富但较重                                                ││
│  │ - Guava Cache: 已被Caffeine取代                                          ││
│  │ - Memcached: 功能不如Redis丰富                                           ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```


### 10.2 前端技术选型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        前端技术选型理由                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Vue 3                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ Composition API 提供更好的代码组织                                     ││
│  │ ✓ 更好的 TypeScript 支持                                                 ││
│  │ ✓ 更小的包体积                                                           ││
│  │ ✓ 更快的渲染性能                                                         ││
│  │ ✓ 学习曲线平缓                                                           ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - React: 生态更大，但JSX学习成本较高                                     ││
│  │ - Angular: 功能全面，但过于重量级                                        ││
│  │ - Svelte: 性能优秀，但生态较小                                           ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Vite                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 极快的冷启动 (基于ESM)                                                 ││
│  │ ✓ 即时热更新 (HMR)                                                       ││
│  │ ✓ 开箱即用的优化                                                         ││
│  │ ✓ 原生支持 TypeScript                                                    ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - Webpack: 功能强大但配置复杂，启动慢                                    ││
│  │ - Parcel: 零配置但灵活性不足                                             ││
│  │ - Rollup: 适合库开发，应用开发不如Vite方便                               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Element Plus                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ Vue 3 原生支持                                                         ││
│  │ ✓ 丰富的组件库                                                           ││
│  │ ✓ 完善的中文文档                                                         ││
│  │ ✓ 活跃的社区                                                             ││
│  │ ✓ 企业级设计规范                                                         ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - Ant Design Vue: 设计风格不同                                           ││
│  │ - Vuetify: Material Design风格                                           ││
│  │ - Naive UI: 较新，生态不如Element成熟                                    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Pinia                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ Vue 3 官方推荐的状态管理                                               ││
│  │ ✓ 更简洁的API                                                            ││
│  │ ✓ 完整的 TypeScript 支持                                                 ││
│  │ ✓ 模块化设计                                                             ││
│  │ ✓ DevTools 支持                                                          ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - Vuex: Vue 2时代的选择，API较繁琐                                       ││
│  │ - 组件状态: 适合简单场景，复杂状态管理困难                               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ECharts                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 功能强大，图表类型丰富                                                 ││
│  │ ✓ 性能优秀，支持大数据量                                                 ││
│  │ ✓ 完善的中文文档                                                         ││
│  │ ✓ 高度可定制                                                             ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - Chart.js: 轻量级，但功能不如ECharts丰富                                ││
│  │ - D3.js: 最灵活，但学习曲线陡峭                                          ││
│  │ - Highcharts: 商业授权                                                   ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 测试技术选型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        测试技术选型理由                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  JUnit 5                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ Java 单元测试的标准                                                    ││
│  │ ✓ 丰富的断言和扩展                                                       ││
│  │ ✓ 参数化测试支持                                                         ││
│  │ ✓ 与Spring Boot无缝集成                                                  ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  jqwik (属性测试)                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 自动生成测试数据                                                       ││
│  │ ✓ 发现边界条件问题                                                       ││
│  │ ✓ 与JUnit 5集成                                                          ││
│  │ ✓ 提高测试覆盖率                                                         ││
│  │                                                                          ││
│  │ 使用场景:                                                                ││
│  │ - 输入验证测试                                                           ││
│  │ - 算法正确性验证                                                         ││
│  │ - 数据转换测试                                                           ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Gatling (性能测试)                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 基于Scala的DSL，表达力强                                               ││
│  │ ✓ 高性能，支持大并发                                                     ││
│  │ ✓ 详细的HTML报告                                                         ││
│  │ ✓ 支持CI/CD集成                                                          ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - JMeter: GUI操作，脚本维护困难                                          ││
│  │ - k6: JavaScript编写，但报告不如Gatling详细                              ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Playwright (E2E测试)                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 选择理由:                                                                ││
│  │ ✓ 跨浏览器支持 (Chrome, Firefox, Safari)                                ││
│  │ ✓ 自动等待机制                                                           ││
│  │ ✓ 强大的选择器                                                           ││
│  │ ✓ 截图和视频录制                                                         ││
│  │                                                                          ││
│  │ 对比其他选项:                                                            ││
│  │ - Cypress: 仅支持Chrome，但API更简洁                                     ││
│  │ - Selenium: 老牌工具，但API较繁琐                                        ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.4 架构决策记录 (ADR)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        架构决策记录                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ADR-001: 采用前后端分离架构                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 状态: 已采纳                                                             ││
│  │ 日期: 2025-01-01                                                        ││
│  │                                                                          ││
│  │ 背景:                                                                    ││
│  │ 需要支持多端访问 (Web用户端、Web管理端、未来可能的移动端)                ││
│  │                                                                          ││
│  │ 决策:                                                                    ││
│  │ 采用前后端分离架构，后端提供RESTful API，前端独立部署                    ││
│  │                                                                          ││
│  │ 后果:                                                                    ││
│  │ + 前后端可独立开发和部署                                                 ││
│  │ + 更好的可扩展性                                                         ││
│  │ + 支持多端复用API                                                        ││
│  │ - 需要处理跨域问题                                                       ││
│  │ - 增加了部署复杂度                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ADR-002: 采用多级缓存策略                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 状态: 已采纳                                                             ││
│  │ 日期: 2025-06-15                                                        ││
│  │                                                                          ││
│  │ 背景:                                                                    ││
│  │ 数据库查询成为性能瓶颈，需要减少数据库访问                               ││
│  │                                                                          ││
│  │ 决策:                                                                    ││
│  │ 采用 Caffeine (L1) + Redis (L2) 多级缓存架构                             ││
│  │                                                                          ││
│  │ 后果:                                                                    ││
│  │ + 显著降低数据库压力                                                     ││
│  │ + 提高响应速度                                                           ││
│  │ + 支持分布式部署                                                         ││
│  │ - 需要处理缓存一致性                                                     ││
│  │ - 增加了系统复杂度                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ADR-003: 采用软删除策略                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 状态: 已采纳                                                             ││
│  │ 日期: 2025-03-20                                                        ││
│  │                                                                          ││
│  │ 背景:                                                                    ││
│  │ 用户可能误删数据，需要支持数据恢复                                       ││
│  │                                                                          ││
│  │ 决策:                                                                    ││
│  │ 对训练记录等重要数据采用软删除，使用 deleted 字段标记                    ││
│  │                                                                          ││
│  │ 后果:                                                                    ││
│  │ + 支持数据恢复                                                           ││
│  │ + 保留历史数据用于分析                                                   ││
│  │ + 满足审计要求                                                           ││
│  │ - 查询需要额外过滤条件                                                   ││
│  │ - 数据库存储增加                                                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ADR-004: 采用JWT无状态认证                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 状态: 已采纳                                                             ││
│  │ 日期: 2025-01-15                                                        ││
│  │                                                                          ││
│  │ 背景:                                                                    ││
│  │ 需要支持分布式部署，避免Session共享问题                                  ││
│  │                                                                          ││
│  │ 决策:                                                                    ││
│  │ 采用JWT进行无状态认证，使用Access Token + Refresh Token模式              ││
│  │                                                                          ││
│  │ 后果:                                                                    ││
│  │ + 无需服务端存储会话                                                     ││
│  │ + 支持水平扩展                                                           ││
│  │ + 跨域友好                                                               ││
│  │ - Token无法主动失效                                                      ││
│  │ - Token体积较大                                                          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 附录

### A. 参考资料

- [Spring Boot 官方文档](https://docs.spring.io/spring-boot/docs/current/reference/html/)
- [Vue 3 官方文档](https://vuejs.org/)
- [Element Plus 官方文档](https://element-plus.org/)
- [Caffeine Wiki](https://github.com/ben-manes/caffeine/wiki)
- [Redis 官方文档](https://redis.io/documentation)

### B. 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0.0 | 2025-01-01 | 开发团队 | 初始版本 |
| v1.1.0 | 2025-06-15 | 开发团队 | 添加缓存架构 |
| v1.2.0 | 2025-09-01 | 开发团队 | 添加监控架构 |
| v1.3.0 | 2025-12-01 | 开发团队 | 添加部署架构 |
| v1.4.0 | 2026-01-08 | 开发团队 | 完善技术选型说明 |

---

> 本文档持续更新中，如有问题请联系开发团队。
